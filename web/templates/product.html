{% extends 'base.html' %}
{% block title %}{{ product.name }} — MaBoutique{% endblock %}
{% block content %}
  <div class="mb-3">
    <a href="{{ url_for('catalog.products') }}" class="text-decoration-none text-muted small">
      ← Retour au catalogue
    </a>
  </div>

  <div class="row g-4 align-items-start">
    <div class="col-md-6">
      <div class="card product-detail-card">
        {% set img_src = product.image_url %}
        {% if img_src and not img_src.startswith('http') and not img_src.startswith('/') %}
          {% set img_src = url_for('static', filename=img_src) %}
        {% endif %}
        <img
          src="{{ img_src or url_for('static', filename='img/default-product.svg') }}"
          class="card-img-top product-detail-image"
          alt="{{ product.name }}"
        >
      </div>
    </div>
    <div class="col-md-6">
      <h1 class="h3 mb-2">{{ product.name }}</h1>
      <p class="text-muted small mb-2">Référence : {{ product.id }}</p>

      <div class="d-flex align-items-center gap-2 mb-3">
        <div class="h3 text-primary mb-0">
          {{ "%.2f"|format(product.price_cents/100) }} €
        </div>
        {% if product.active %}
          <span class="badge bg-success-subtle text-success border badge-soft-success">
            En stock
          </span>
        {% else %}
          <span class="badge bg-secondary">Indisponible</span>
        {% endif %}
        {% if current_user.is_authenticated and current_user.is_admin and not product.active %}
          <span class="badge bg-secondary ms-1">Désactivé (admin)</span>
        {% endif %}
      </div>

      {% if product.description %}
        <p class="mb-4">{{ product.description }}</p>
      {% endif %}

      <!-- Formulaire HTMX d'ajout au panier -->
      {% if product.active %}
        <form 
          hx-post="{{ url_for('cart.add', product_id=product.id) }}"
          hx-headers='{"X-CSRFToken": "{{ csrf_token() }}"}'
          hx-target="#cart-count"
          hx-swap="outerHTML"
          hx-on="htmx:afterRequest: showAddedToast()"
          class="d-flex flex-column flex-sm-row align-items-stretch align-items-sm-end gap-2 mb-3"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="w-100 w-sm-25" style="max-width: 140px;">
            <label for="qty" class="form-label small mb-1">Quantité</label>
            <input
              type="number"
              name="quantity"
              id="qty"
              class="form-control"
              value="1"
              min="1"
            >
          </div>
          <div class="flex-grow-1 d-flex">
            <button type="submit" class="btn btn-primary w-100">
              Ajouter au panier
            </button>
          </div>
        </form>
      {% else %}
        <div class="alert alert-warning">
          Ce produit est désactivé et ne peut pas être ajouté au panier.
        </div>
      {% endif %}

      <hr>
      <div class="small text-muted">
        <div>✓ Livraison estimée : 2–4 jours</div>
        <div>✓ Paiement sécurisé (simulation pour le projet)</div>
        <div>✓ Service client disponible via l'espace Support</div>
      </div>
    </div>
  </div>
{% endblock %}
